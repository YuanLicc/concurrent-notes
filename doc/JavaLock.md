## Java 中的锁

#### Lock 接口

锁是用来控制多个线程访问共享资源的方式，一般来说，一个锁能够防止多个线程同时访问共享资源（有些锁可以允许多个线程并发的访问共享资源，比如读写锁）。在 `Lock` 接口出现之前，`Java` 程序是靠 `synchronized` 关键字实现锁功能的，在 `Java SE 5` 之后，并发包中新增了 `Lock` 接口及其实现类用来实现锁功能，它提供了与 `synchronized` 关键字类似的同步功能，只是使用时需要显示的获取和释放锁。虽然它缺少了隐式获取释放锁的便捷性，但是却拥有了锁获取与释放的可操作性、可中断的获取锁以及超时获取锁等多种 `synchronized` 关键字所不具备的同步特性。

使用 `synchronized` 关键字将会隐式地获取锁，但是它将锁的获取和释放固化了，也就是先获取再释放。当然，这种方式简化了同步的管理，可是扩展性没有显示的锁获取和释放来的好，如：我们需要在释放锁之前获取另一个锁。

`Lock` 的使用：

```java
Lock lock = new ReetrantLock();

lock.lock();

try{
    //
}
finally{
    lock.unlock();
}
```

不要将获取锁的过程写在 `try` 块内，因为如果在获取锁（自定义锁）时发生异常，异常抛出的同时，也会导致锁无故释放。`Lock` 接口提供了一下特性：

| 特性             | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| 尝试非阻塞获取锁 | 当前线程尝试获取锁，如果这一时刻锁没有被其它线程获取到，则成功获取并持有锁 |
| 能被中断的获取锁 | 与`synchronized` 不同，获取锁的线程能够响应中断，当获取到锁的线程被中断时，中断异常将会被抛出，同时锁会被释放 |
| 超时获取锁       | 在指定的截止时间之前获取锁，如果截止时间到了仍旧未获取锁，则返回 |

`Lock` 接口：

| 方法               | 描述                                                         |
| ------------------ | ------------------------------------------------------------ |
| lock               | 获取锁，调用该方法当前线程会获取锁，当锁获得后，从该方法返回 |
| lockInterruptibly  | 可中断的获取锁，和 `lock` 方法的不同之处在于该方法会响应中断，即在锁的获取中可以中断当前线程 |
| tryLock            | 尝试非阻塞的获取锁，调用该方法后立即返回，如果能够获取则返回 `true`，否则返回`false` |
| tryLock(time,unit) | 超时的获取锁，当前线程在以下三种情况下会返回：<br />1）当前线程在超时时间内获得了锁<br />2）当前线程在超时时间内被中断<br />3）超时时间结束，返回 `false` |
| unlock             | 释放锁                                                       |
| newCondition       | 获取等待通知组件，该组件和当前的锁绑定，当前线程只有获得了锁，才能调用该组件的 `wait` 方法，调用后，当前线程将释放锁 |

### 队列同步器

队列同步器 `AbstractQueuedSynchronized`，是用来构建锁或者其它同步组件的基础框架，它使用了一个 `int` 成员变量表示同步状态，通过内置的 `FIFO` 队列来完成资源获取线程的排队工作。同步器的主要使用方式是继承，子类通过集成同步器并实现它的抽象方法来管理同步状态，在抽象方法的实现过程中免不了要对同步状态进行更改，这时就需要使用同步器提供的三个方法：`getState`、`setState`、`compareAndSetState` 来进行操作，因为他们能够保证状态的改变是安全的，同步器的子类应该定义为自定义同步组件的静态内部类，同步器自身没有实现任何同步接口，它仅仅是定义了若干同步状态获取和释放的方法来供自定义同步组件使用，同步器既可以支持独占式地获取同步状态，也可以支持共享式的获取同步状态，这样可以方便实现不同类型的同步组件。

同步器是实现锁的关键，在锁的实现中聚合同步器，利用同步器实现锁的语义。二者的关系：锁是面向使用者的，它定义了使用者与锁交互的接口，隐藏了实现细节。同步器面向的是锁的实现者，它简化了锁的实现方式，屏蔽了同步状态管理、线程的排队、等待与唤醒等底层操作。锁和同步器很好的隔离了使用者和实现者所需关注的领域。

#### 队列同步器接口



