 [本文部分摘自书籍《Java并发编程的艺术》](https://www.amazon.cn/dp/B012NDCEA0/ref=sr_1_1?s=books&ie=UTF8&qid=1523863156&sr=1-1&keywords=java%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E7%9A%84%E8%89%BA%E6%9C%AF)
### 预备知识

#### 悲观锁

&#8194;&#8194;&#8194;&#8194;当有线程占有锁时，其它需要锁的线程会被挂起，等待持有锁的线程释放锁，具有强烈的独占性和排他性。悲观锁假设最悲观的情况（也就是会发生并发冲突），为了避免并发冲突，会使得其它需要锁的线程挂起，以免可能发生的数据完整性破坏情况，而挂起和恢复会造成很大的开销，挂起期间，线程不能做任何事情，所以悲观锁的缺点显而易见。例子：synchronized（独占锁的应用）。

#### 乐观锁

&#8194;&#8194;&#8194;&#8194;假设并发线程在处理时不会彼此互相影响，各个线程能够在不产生锁的情况下处理各自影响的数据。若出现冲突而失败，会进行重试，直到成功为止。可以看出，若数据竞争的概率小的情况下，使用乐观锁更好。例子：CAS

#### CPU内存屏障（memory barrier）  

&#8194;&#8194;&#8194;&#8194;程序运行时内存实际的访问顺序和程序代码编写的顺序往往不一定一致，这被称为内存乱序访问。内存乱序访问出现的理由是为了提升程序运行的性能。主要发生在两个阶段：编译时，编译器优化造成的指令重排；运行时，CPU间交互引起的内存乱序访问。而内存屏障恰恰是一个能使得内存访问有序的一组指令。内存乱序一般不会有问题，但是部分程序逻辑对内存访问顺序依赖很高，可能会造成程序逻辑错误，特别是涉及到多线程的程序。

#### CPU缓存行（cache line）

&#8194;&#8194;&#8194;&#8194;CPU内的缓存（一级缓存、二级缓存等）可以分配的最小存储单位，由于不同的CPU的缓存行大小不同，假设缓存行为32字节，那么一个缓存行可以存储32字节的数据，而缓存从内存读入数据也会将目标数据所在分组的32字节数据一起读取到该缓存行，也就是说可能会读入一些我们不需要的数据到缓存行。

#### CPU原子操作（atomic operations）

&#8194;&#8194;&#8194;&#8194;不可中断的一个或一系列操作。

#### CPU缓存行填充（cache line fill）

&#8194;&#8194;&#8194;&#8194;简单来说就是读入内存数据到缓存行。前面CPU缓存行已经说到了。重点就是，会读取目标数据所在分组的缓存行大小（前面说的是32字节）的数据。

#### 缓存行命中（cache hit）

&#8194;&#8194;&#8194;&#8194;进行缓存行填充的内存位置任然是下次处理器访问的地址时，处理器从缓存行中读取操作数而不是从内存中读取。

#### 写命中（write hit）

&#8194;&#8194;&#8194;&#8194;当处理器将操作数写回到一个内存缓存的区域时，他首先会检查这个缓存的内存地址是否在存中，如果存在一个有效的缓存行，则处理器将这个操作数写回到川村，而不是写回到内存，这个操作被称为写命中。

#### 写缺失（write misses the cache）

&#8194;&#8194;&#8194;&#8194;一个有效的缓存行被写入到不存在的内存区域。

#### 比较并交换 （Compare and Swap即CAS）

&#8194;&#8194;&#8194;&#8194;CAS操作需要输入两个数值，一个旧值（期望操作前的值）和一个新值，在操作期间先比较旧值有没有发生变化，如果没有发生变化，才交换成新值，发生了变化则不进行交换。

#### CPU流水线（CPU pipeline）

&#8194;&#8194;&#8194;&#8194;CPU流水线的工作方式就像工业生产上的装配流水线，在CPU中由5-6个不同功能的电路单元组成一条指令处理流水线，然后将一条X86指令分成5-6步后再由这些电路单元分别执行，这样就能实现在一个CPU始终周期完成一条指令，因此提高CPU的运算书读。

#### 内存顺序冲突（Memory order violation）

&#8194;&#8194;&#8194;&#8194;内存顺序冲突一般是由假共享引起的，假共享是指多个CPU同时修改同一个缓存行的不同部分引起其中一个CPU的操作无效，当出现这个内存顺序冲突时，CPU必须清空流水线。

#### Java并发临界区

&#8194;&#8194;&#8194;&#8194;我们把同一时刻，只能有一个线程访问的代码区称为临界区。
